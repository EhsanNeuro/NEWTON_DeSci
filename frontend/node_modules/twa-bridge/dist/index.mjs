import{createJsonStructParser as e,parseJsonParamAsNum as t,parseJsonParamAsOptNum as n,parseJsonParamAsBool as r,parseJsonParamAsRecord as i,parseJsonParamAsOptString as o,parseJsonParamAsString as a,EventEmitter as s,isRecord as c,log as u,compareVersions as d}from"twa-core";var p=function(){return p=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},p.apply(this,arguments)};function l(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}function v(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}var f=e({height:["height",t],width:["width",n],is_state_stable:["is_state_stable",r],is_expanded:["is_expanded",r]}),_=e({theme_params:["theme_params",i]});var g,h=e({button_id:["button_id",function(e){return null==e?void 0:a(e)}]}),b=e({data:["data",o]}),w=e({slug:["slug",a],status:["status",a]}),m=e({req_id:["req_id",a],data:["data",function(e){return null==e?e:a(e)}]}),y=e({type:["eventType",a],data:["eventData",function(e){return e}]});function E(e){if(void 0===e&&(e=!1),void 0===g){var t=new s,n=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];e&&u.apply(void 0,v([t,"[Bridge]"],n,!1))};window.addEventListener("message",(function(e){var r;if(n("log","message event received",e),e instanceof MessageEvent){if(e.source!==window.parent||"string"!=typeof e.data)return n("log","event rejected",e);r=e.data}else{if(!(e instanceof CustomEvent&&c(e.detail)&&"string"==typeof e.detail.eventType&&"eventData"in e.detail))return n("warn","event was skipped",e);r=e.detail}try{var i=y(r),o=i.type,a=i.data;t.emit("message",o,a)}catch(e){n("error","event data extraction error",r,e)}})),window.addEventListener("resize",(function(){var e={width:window.innerWidth,height:window.innerHeight,is_state_stable:!0,is_expanded:!0};t.emit("message","viewport_changed",e)})),g=t}return g}var O=!1;function x(e){if(void 0===e&&(e=!1),!O||e){var t=window;[["TelegramGameProxy_receiveEvent"],["TelegramGameProxy","receiveEvent"],["Telegram","WebView","receiveEvent"]].forEach((function(e){var n=t;e.forEach((function(e,t,r){t!==r.length-1?(e in n||(n[e]={}),n=n[e]):n[e]=function(e,t){window.dispatchEvent(new CustomEvent("message",{detail:{eventType:e,eventData:t}}))}}))})),O=!0}}function T(e){return void 0!==e.TelegramWebviewProxy}function P(e){return"external"in e&&"function"==typeof e.external.notify}function j(){try{return window.self!==window.top}catch(e){return!0}}function k(e,t,n){if(void 0===t&&(t=""),void 0===n&&(n={}),j())return window.parent.postMessage(JSON.stringify({eventType:e,eventData:t}),n.targetOrigin||"https://web.telegram.org");if(T(window))return window.TelegramWebviewProxy.postEvent(e,JSON.stringify(t));if(P(window))return window.external.notify(JSON.stringify({eventType:e,eventData:t}));throw new Error("Unable to determine current environment and possible way to send event.")}var q=function(){function e(e){void 0===e&&(e={});var t=this;this._boundEmitter=null,this.ee=new s,this.emit=function(e){for(var n,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];t.log.apply(t,v(["log","[emit]",e],r,!1)),(n=t.ee).emit.apply(n,v([e],r,!1))},this.emitUnsafe=function(e){for(var n,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];t.log.apply(t,v(["log","[emitUnsafe]",e],r,!1)),(n=t.ee).emitUnsafe.apply(n,v([e],r,!1))},this.log=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];t.debug&&u.apply(void 0,v([e,"[Bridge]"],n,!1))},this.processEvent=function(e,n){t.log("log","[processEvent]",e,n);try{switch(e){case"viewport_changed":return t.emit(e,function(e){var t=f(e),n=t.width,r=l(t,["width"]);return p(p({},r),{width:null===n?window.innerWidth:n})}(n));case"theme_changed":return t.emit(e,_(n));case"popup_closed":return null==n?t.emit(e,{}):t.emit(e,h(n));case"set_custom_style":return t.emit(e,a(n));case"qr_text_received":return t.emit(e,b(n));case"main_button_pressed":case"back_button_pressed":case"settings_button_pressed":case"scan_qr_popup_closed":return t.emit(e);case"clipboard_text_received":return t.emit(e,m(n));case"invoice_closed":return t.emit(e,w(n));default:return t.emitUnsafe(e,n)}}catch(e){throw t.log("error","[processEvent] error",e),e}},this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this.postEvent=function(e,n,r){var i=r||{},o=i.targetOrigin,a=void 0===o?t.targetOrigin:o,s=l(i,["targetOrigin"]);k(e,n,p(p({},s),{targetOrigin:a})),t.log("log","[postEvent]",e,n)},this.subscribe=this.ee.subscribe.bind(this.ee),this.unsubscribe=this.ee.unsubscribe.bind(this.ee);var n=e.debug,r=void 0!==n&&n,i=e.emitter,o=void 0===i?null:i,c=e.targetOrigin,d=void 0===c?"https://web.telegram.org":c;this.debug=r,this.targetOrigin=d,this.boundEmitter=o}return Object.defineProperty(e.prototype,"boundEmitter",{get:function(){return this._boundEmitter||null},set:function(e){null!==this._boundEmitter&&this._boundEmitter.off("message",this.processEvent),this._boundEmitter=e,null!==this._boundEmitter&&this._boundEmitter.on("message",this.processEvent)},enumerable:!1,configurable:!0}),e.prototype.bind=function(e){this.boundEmitter=e},e.prototype.unbind=function(){this.boundEmitter=null},e}();function D(e){void 0===e&&(e={});var t=e.defineReceiver,n=void 0===t||t,r=e.emitter,i=void 0===r?E():r,o=l(e,["defineReceiver","emitter"]);return n&&x(),new q(p(p({},o),{emitter:i}))}function S(e,t){switch(e){case"web_app_open_tg_link":case"web_app_open_invoice":case"web_app_setup_back_button":case"web_app_set_background_color":case"web_app_set_header_color":case"web_app_trigger_haptic_feedback":return d("6.1",t)<=0;case"web_app_open_popup":return d("6.2",t)<=0;case"web_app_close_scan_qr_popup":case"web_app_open_scan_qr_popup":case"web_app_read_text_from_clipboard":return d("6.4",t)<=0;default:return!0}}export{q as Bridge,x as defineEventReceiver,E as getGlobalEventEmitter,D as init,j as isBrowserEnv,T as isDesktopOrMobileEnv,P as isWindowsPhoneEnv,k as postEvent,S as supports};
