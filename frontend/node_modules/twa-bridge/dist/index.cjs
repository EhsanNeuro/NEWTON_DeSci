"use strict";var e=require("twa-core"),t=function(){return t=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},t.apply(this,arguments)};function r(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function n(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;i<o;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))}var i=e.createJsonStructParser({height:["height",e.parseJsonParamAsNum],width:["width",e.parseJsonParamAsOptNum],is_state_stable:["is_state_stable",e.parseJsonParamAsBool],is_expanded:["is_expanded",e.parseJsonParamAsBool]}),o=e.createJsonStructParser({theme_params:["theme_params",e.parseJsonParamAsRecord]});var s,a=e.createJsonStructParser({button_id:["button_id",function(t){return null==t?void 0:e.parseJsonParamAsString(t)}]}),c=e.createJsonStructParser({data:["data",e.parseJsonParamAsOptString]}),p=e.createJsonStructParser({slug:["slug",e.parseJsonParamAsString],status:["status",e.parseJsonParamAsString]}),u=e.createJsonStructParser({req_id:["req_id",e.parseJsonParamAsString],data:["data",function(t){return null==t?t:e.parseJsonParamAsString(t)}]}),d=e.createJsonStructParser({type:["eventType",e.parseJsonParamAsString],data:["eventData",function(e){return e}]});function l(t){if(void 0===t&&(t=!1),void 0===s){var r=new e.EventEmitter,i=function(r){for(var i=[],o=1;o<arguments.length;o++)i[o-1]=arguments[o];t&&e.log.apply(void 0,n([r,"[Bridge]"],i,!1))};window.addEventListener("message",(function(t){var n;if(i("log","message event received",t),t instanceof MessageEvent){if(t.source!==window.parent||"string"!=typeof t.data)return i("log","event rejected",t);n=t.data}else{if(!(t instanceof CustomEvent&&e.isRecord(t.detail)&&"string"==typeof t.detail.eventType&&"eventData"in t.detail))return i("warn","event was skipped",t);n=t.detail}try{var o=d(n),s=o.type,a=o.data;r.emit("message",s,a)}catch(e){i("error","event data extraction error",n,e)}})),window.addEventListener("resize",(function(){var e={width:window.innerWidth,height:window.innerHeight,is_state_stable:!0,is_expanded:!0};r.emit("message","viewport_changed",e)})),s=r}return s}var v=!1;function g(e){if(void 0===e&&(e=!1),!v||e){var t=window;[["TelegramGameProxy_receiveEvent"],["TelegramGameProxy","receiveEvent"],["Telegram","WebView","receiveEvent"]].forEach((function(e){var r=t;e.forEach((function(e,t,n){t!==n.length-1?(e in r||(r[e]={}),r=r[e]):r[e]=function(e,t){window.dispatchEvent(new CustomEvent("message",{detail:{eventType:e,eventData:t}}))}}))})),v=!0}}function f(e){return void 0!==e.TelegramWebviewProxy}function m(e){return"external"in e&&"function"==typeof e.external.notify}function _(){try{return window.self!==window.top}catch(e){return!0}}function h(e,t,r){if(void 0===t&&(t=""),void 0===r&&(r={}),_())return window.parent.postMessage(JSON.stringify({eventType:e,eventData:t}),r.targetOrigin||"https://web.telegram.org");if(f(window))return window.TelegramWebviewProxy.postEvent(e,JSON.stringify(t));if(m(window))return window.external.notify(JSON.stringify({eventType:e,eventData:t}));throw new Error("Unable to determine current environment and possible way to send event.")}var b=function(){function s(s){void 0===s&&(s={});var d=this;this._boundEmitter=null,this.ee=new e.EventEmitter,this.emit=function(e){for(var t,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];d.log.apply(d,n(["log","[emit]",e],r,!1)),(t=d.ee).emit.apply(t,n([e],r,!1))},this.emitUnsafe=function(e){for(var t,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];d.log.apply(d,n(["log","[emitUnsafe]",e],r,!1)),(t=d.ee).emitUnsafe.apply(t,n([e],r,!1))},this.log=function(t){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];d.debug&&e.log.apply(void 0,n([t,"[Bridge]"],r,!1))},this.processEvent=function(n,s){d.log("log","[processEvent]",n,s);try{switch(n){case"viewport_changed":return d.emit(n,function(e){var n=i(e),o=n.width,s=r(n,["width"]);return t(t({},s),{width:null===o?window.innerWidth:o})}(s));case"theme_changed":return d.emit(n,o(s));case"popup_closed":return null==s?d.emit(n,{}):d.emit(n,a(s));case"set_custom_style":return d.emit(n,e.parseJsonParamAsString(s));case"qr_text_received":return d.emit(n,c(s));case"main_button_pressed":case"back_button_pressed":case"settings_button_pressed":case"scan_qr_popup_closed":return d.emit(n);case"clipboard_text_received":return d.emit(n,u(s));case"invoice_closed":return d.emit(n,p(s));default:return d.emitUnsafe(n,s)}}catch(e){throw d.log("error","[processEvent] error",e),e}},this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this.postEvent=function(e,n,i){var o=i||{},s=o.targetOrigin,a=void 0===s?d.targetOrigin:s,c=r(o,["targetOrigin"]);h(e,n,t(t({},c),{targetOrigin:a})),d.log("log","[postEvent]",e,n)},this.subscribe=this.ee.subscribe.bind(this.ee),this.unsubscribe=this.ee.unsubscribe.bind(this.ee);var l=s.debug,v=void 0!==l&&l,g=s.emitter,f=void 0===g?null:g,m=s.targetOrigin,_=void 0===m?"https://web.telegram.org":m;this.debug=v,this.targetOrigin=_,this.boundEmitter=f}return Object.defineProperty(s.prototype,"boundEmitter",{get:function(){return this._boundEmitter||null},set:function(e){null!==this._boundEmitter&&this._boundEmitter.off("message",this.processEvent),this._boundEmitter=e,null!==this._boundEmitter&&this._boundEmitter.on("message",this.processEvent)},enumerable:!1,configurable:!0}),s.prototype.bind=function(e){this.boundEmitter=e},s.prototype.unbind=function(){this.boundEmitter=null},s}();exports.Bridge=b,exports.defineEventReceiver=g,exports.getGlobalEventEmitter=l,exports.init=function(e){void 0===e&&(e={});var n=e.defineReceiver,i=void 0===n||n,o=e.emitter,s=void 0===o?l():o,a=r(e,["defineReceiver","emitter"]);return i&&g(),new b(t(t({},a),{emitter:s}))},exports.isBrowserEnv=_,exports.isDesktopOrMobileEnv=f,exports.isWindowsPhoneEnv=m,exports.postEvent=h,exports.supports=function(t,r){switch(t){case"web_app_open_tg_link":case"web_app_open_invoice":case"web_app_setup_back_button":case"web_app_set_background_color":case"web_app_set_header_color":case"web_app_trigger_haptic_feedback":return e.compareVersions("6.1",r)<=0;case"web_app_open_popup":return e.compareVersions("6.2",r)<=0;case"web_app_close_scan_qr_popup":case"web_app_open_scan_qr_popup":case"web_app_read_text_from_clipboard":return e.compareVersions("6.4",r)<=0;default:return!0}};
