"use strict";var e=require("twa-core"),t=require("twa-bridge"),i=require("twa-theme-params"),o=require("twa-init-data");function r(e){var t=document.createElement("a");if(t.href=e,"http:"!==t.protocol&&"https:"!==t.protocol)throw Error("URL protocol is not supported by OS, or link has not allowed "+"protocol: ".concat(t.protocol));return t.href}function n(e,i){return function(o){return t.supports(i[o],e)}}var s=function(){function t(t,i){var o=this;this.bridge=t,this.ee=new e.EventEmitter,this._isVisible=!1,this.on=function(e,t){if("click"===e)return o.bridge.on("back_button_pressed",t);o.ee.on(e,t)},this.off=function(e,t){if("click"===e)return o.bridge.off("back_button_pressed",t);o.ee.off(e,t)},this.supports=n(i,{show:"web_app_setup_back_button",hide:"web_app_setup_back_button"})}return Object.defineProperty(t.prototype,"isVisible",{get:function(){return this._isVisible},set:function(e){this.bridge.postEvent("web_app_setup_back_button",{is_visible:e}),this._isVisible!==e&&(this._isVisible=e,this.ee.emit("visibleChanged",e))},enumerable:!1,configurable:!0}),t.prototype.hide=function(){this.isVisible=!1},t.prototype.show=function(){this.isVisible=!0},t}(),a=function(){function t(t){this.bridge=t,this.ee=new e.EventEmitter,this._isEnabled=!1,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee)}return Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this.bridge.postEvent("web_app_setup_closing_behavior",{need_confirmation:e}),this._isEnabled!==e&&(this._isEnabled=e,this.ee.emit("change",e))},enumerable:!1,configurable:!0}),t.prototype.disable=function(){this.isEnabled=!1},t.prototype.enable=function(){this.isEnabled=!0},t}(),c=function(){function e(e,t){this.bridge=e,this.supports=n(t,{impactOccurred:"web_app_trigger_haptic_feedback",notificationOccurred:"web_app_trigger_haptic_feedback",selectionChanged:"web_app_trigger_haptic_feedback"})}return e.prototype.impactOccurred=function(e){this.bridge.postEvent("web_app_trigger_haptic_feedback",{type:"impact",impact_style:e})},e.prototype.notificationOccurred=function(e){this.bridge.postEvent("web_app_trigger_haptic_feedback",{type:"notification",notification_type:e})},e.prototype.selectionChanged=function(){this.bridge.postEvent("web_app_trigger_haptic_feedback",{type:"selection_change"})},e}(),p=function(){function e(e,t,i){void 0===i&&(i={}),this._authDate=e,this._hash=t,this._canSendAfter=null,this._chat=null,this._queryId=null,this._receiver=null,this._startParam=null,this._user=null;var o=i.chat,r=void 0===o?null:o,n=i.user,s=void 0===n?null:n,a=i.queryId,c=void 0===a?null:a,p=i.receiver,h=void 0===p?null:p,u=i.startParam,l=void 0===u?null:u,f=i.canSendAfter,b=void 0===f?null:f;this._canSendAfter=b,this._chat=r,this._user=s,this._queryId=c,this._receiver=h,this._startParam=l}return Object.defineProperty(e.prototype,"authDate",{get:function(){return this._authDate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canSendAfter",{get:function(){return this._canSendAfter},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"chat",{get:function(){return this._chat},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hash",{get:function(){return this._hash},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"queryId",{get:function(){return this._queryId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"receiver",{get:function(){return this._receiver},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"startParam",{get:function(){return this._startParam},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"user",{get:function(){return this._user},enumerable:!1,configurable:!0}),e}(),h=function(){function t(t,i,o,r){this.bridge=t,this._headerColor=o,this._backgroundColor=r,this.ee=new e.EventEmitter,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this.supports=n(i,{setHeaderColor:"web_app_set_header_color",setBackgroundColor:"web_app_set_background_color"})}return Object.defineProperty(t.prototype,"backgroundColor",{get:function(){return this._backgroundColor},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"colorScheme",{get:function(){return e.isColorDark(this.backgroundColor)?"dark":"light"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"headerColor",{get:function(){return this._headerColor},enumerable:!1,configurable:!0}),t.prototype.setBackgroundColor=function(e){this.bridge.postEvent("web_app_set_background_color",{color:e}),this._backgroundColor!==e&&(this._backgroundColor=e,this.ee.emit("backgroundColorChanged",e))},t.prototype.setHeaderColor=function(e){this.bridge.postEvent("web_app_set_header_color",{color_key:e}),this._headerColor!==e&&(this._headerColor=e,this.ee.emit("headerColorChanged",e))},t}(),u=function(){function t(t,i,o,r){void 0===r&&(r={});var n=this;this.bridge=t,this._color=i,this._textColor=o,this.ee=new e.EventEmitter,this._isActive=!1,this._isVisible=!1,this._isProgressVisible=!1,this._text="",this.on=function(e,t){if("click"===e)return n.bridge.on("main_button_pressed",t);n.ee.on(e,t)},this.off=function(e,t){if("click"===e)return n.bridge.off("main_button_pressed",t);n.ee.off(e,t)};var s=r.autocommit,a=void 0===s||s;this.autocommit=a}return Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(e){var t=this._color;this._color=e,this.autocommit&&this.commit(),this._color!==t&&this.ee.emit("colorChanged",this._color)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isActive",{get:function(){return this._isActive},set:function(e){var t=this._isActive;this._isActive=e,this.autocommit&&this.commit(),this._isActive!==t&&this.ee.emit("activeChanged",this._isActive)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isProgressVisible",{get:function(){return this._isProgressVisible},set:function(e){var t=this._isProgressVisible;this._isProgressVisible=e,this.autocommit&&this.commit(),this._isProgressVisible!==t&&this.ee.emit("progressVisibleChanged",this._isProgressVisible)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isVisible",{get:function(){return this._isVisible},set:function(e){var t=this._isVisible;this._isVisible=e,this.autocommit&&this.commit(),this._isVisible!==t&&this.ee.emit("visibleChanged",this._isVisible)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"text",{get:function(){return this._text},set:function(e){var t=this._text;this._text=e,this.autocommit&&this.commit(),this._text!==t&&this.ee.emit("textChanged",e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textColor",{get:function(){return this._textColor},set:function(e){var t=this._textColor;this._textColor=e,this.autocommit&&this.commit(),this._textColor!==t&&this.ee.emit("textColorChanged",this._textColor)},enumerable:!1,configurable:!0}),t.prototype.commit=function(){""!==this.text&&this.bridge.postEvent("web_app_setup_main_button",{is_visible:this.isVisible,is_active:this.isActive,is_progress_visible:this.isProgressVisible,text:this.text,color:this.color,text_color:this.textColor})},t.prototype.disable=function(){return this.isActive=!1,this},t.prototype.enable=function(){return this.isActive=!0,this},t.prototype.hide=function(){return this.isVisible=!1,this},t.prototype.hideProgress=function(){return this.isProgressVisible=!1,this},t.prototype.show=function(){return this.isVisible=!0,this},t.prototype.showProgress=function(){return this.isProgressVisible=!0,this},t.prototype.setText=function(e){return this.text=e,this},t.prototype.setTextColor=function(e){return this.textColor=e,this},t.prototype.setColor=function(e){return this.color=e,this},t}(),l=function(e,t){return l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},l(e,t)};var f=function(){return f=Object.assign||function(e){for(var t,i=1,o=arguments.length;i<o;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},f.apply(this,arguments)};function b(e,t,i,o){return new(i||(i=Promise))((function(r,n){function s(e){try{c(o.next(e))}catch(e){n(e)}}function a(e){try{c(o.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))}function d(e,t){var i,o,r,n,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(a){return function(c){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;n&&(n=0,a[0]&&(s=0)),s;)try{if(i=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){s.label=a[1];break}if(6===a[0]&&s.label<r[1]){s.label=r[1],r=a;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(a);break}r[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],o=0}finally{i=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}var _=function(){function t(t,i){this.bridge=t,this.ee=new e.EventEmitter,this._isOpened=!1,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this.supports=n(i,{open:"web_app_open_popup"})}return Object.defineProperty(t.prototype,"isOpened",{get:function(){return this._isOpened},set:function(e){this._isOpened!==e&&(this._isOpened=e,this.ee.emit("openChanged",this._isOpened))},enumerable:!1,configurable:!0}),t.prototype.open=function(e){var t=this;if(this.isOpened)throw new Error("Popup is already opened.");var i=function(e){var t=e.message.trim(),i=(e.title||"").trim(),o=e.buttons||[];if(i.length>64)throw new Error("Title has incorrect size: ".concat(i.length));if(0===t.length||t.length>256)throw new Error("Message has incorrect size: ".concat(t.length));if(o.length>3)throw new Error("Buttons have incorrect size: ".concat(o.length));return{title:i,message:t,buttons:0===o.length?[{type:"close",id:""}]:o.map((function(e){var t=e.id,i=void 0===t?"":t;if(i.length>64)throw new Error("Button ID has incorrect size: ".concat(i));switch(e.type){case void 0:case"default":case"destructive":if(e.text=e.text.trim(),0===e.text.length||e.text.length>64){var o=e.type||"default";throw new Error('Button text with type "'.concat(o,'" has incorrect size: ').concat(e.text.length))}}return f(f({},e),{id:i})}))}}(e);return this.bridge.postEvent("web_app_open_popup",i),this.isOpened=!0,new Promise((function(e){var i=function(o){var r=o.button_id,n=void 0===r?null:r;t.bridge.off("popup_closed",i),e(n),t.isOpened=!1};t.bridge.on("popup_closed",i)}))},t}(),g=function(){function t(t,i){this.bridge=t,this._isOpened=!1,this.ee=new e.EventEmitter,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this.supports=n(i,{close:"web_app_close_scan_qr_popup",open:"web_app_open_scan_qr_popup"})}return t.prototype.close=function(){this.bridge.postEvent("web_app_close_scan_qr_popup"),this.isOpened=!1},Object.defineProperty(t.prototype,"isOpened",{get:function(){return this._isOpened},set:function(e){this._isOpened!==e&&(this._isOpened=e,this.ee.emit("openChanged",e))},enumerable:!1,configurable:!0}),t.prototype.open=function(e){var t=this;if(this.isOpened)throw new Error("QR scanner is already opened.");return this.bridge.postEvent("web_app_open_scan_qr_popup",{text:e}),this.isOpened=!0,new Promise((function(e){var i=function(){e(null),r()},o=function(t){var i=t.data;e(void 0===i?null:i),r()},r=function(){t.bridge.off("scan_qr_popup_closed",i),t.bridge.off("qr_text_received",o)};t.bridge.on("qr_text_received",o),t.bridge.on("scan_qr_popup_closed",i)}))},t}(),m=function(){function t(t){this.ee=new e.EventEmitter,this._backgroundColor=null,this._buttonColor=null,this._buttonTextColor=null,this._hintColor=null,this._linkColor=null,this._secondaryBackgroundColor=null,this._textColor=null,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this.assignThemeParams(t,!1)}return t.request=function(e){return e.postEvent("web_app_request_theme"),new Promise((function(t){var o=function(r){e.off("theme_changed",o),t(i.extractThemeFromJson(r))};e.on("theme_changed",o)}))},t.synced=function(e,o){var r=new t(o);return e.on("theme_changed",(function(e){r.assignThemeParams(i.extractThemeFromJson(e),!0)})),r},t.prototype.assignThemeParams=function(e,t){var i=this,o=!1;["buttonColor","buttonTextColor","linkColor","textColor","hintColor","secondaryBackgroundColor","backgroundColor"].forEach((function(t){var r=e[t];if(void 0!==r){var n="_"+t;i[n]!==r&&(i[n]=r,o=!0)}})),o&&t&&this.ee.emit("change")},Object.defineProperty(t.prototype,"backgroundColor",{get:function(){return this._backgroundColor},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonColor",{get:function(){return this._buttonColor},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonTextColor",{get:function(){return this._buttonTextColor},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hintColor",{get:function(){return this._hintColor},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isDark",{get:function(){var t=this.backgroundColor;return null===t||e.isColorDark(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"linkColor",{get:function(){return this._linkColor},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"secondaryBackgroundColor",{get:function(){return this._secondaryBackgroundColor},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textColor",{get:function(){return this._textColor},enumerable:!1,configurable:!0}),t}();function y(e){return e<0?0:e}var v=function(){function t(t,i,o,r,n){this.bridge=t,this.ee=new e.EventEmitter,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this._height=y(i),this._width=y(o),this._stableHeight=y(r),this._isExpanded=n}return t.request=function(e){return e.postEvent("web_app_request_viewport"),new Promise((function(t){var i=function(o){e.off("viewport_changed",i);var r=o.height,n=o.width,s=o.is_expanded,a=o.is_state_stable;t({height:r,isExpanded:s,width:n,isStateStable:a})};e.on("viewport_changed",i)}))},t.synced=function(e,i,o,r,n){var s=new t(e,i,o,r,n);return e.on("viewport_changed",(function(e){var t=e.height,i=e.width,o=e.is_expanded,r=e.is_state_stable;s.height=y(t),s.width=y(i),s.isExpanded=o,r&&(s.stableHeight=s.height)})),s},Object.defineProperty(t.prototype,"height",{get:function(){return this._height},set:function(e){this._height!==e&&(this._height=e,this.ee.emit("heightChanged",e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stableHeight",{get:function(){return this._stableHeight},set:function(e){this._stableHeight!==e&&(this._stableHeight=e,this.ee.emit("stableHeightChanged",e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isExpanded",{get:function(){return this._isExpanded},set:function(e){this._isExpanded!==e&&(this._isExpanded=e,this.ee.emit("expansionChanged",e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this.ee.emit("widthChanged",e))},enumerable:!1,configurable:!0}),t.prototype.expand=function(){this.bridge.postEvent("web_app_expand")},Object.defineProperty(t.prototype,"isStable",{get:function(){return this._stableHeight===this._height},enumerable:!1,configurable:!0}),t}(),w=function(){function i(e,t,i){this.bridge=e,this._platform=i,this.supports=n(t,{openInvoice:"web_app_open_invoice",readTextFromClipboard:"web_app_read_text_from_clipboard"}),this.version=t}return i.prototype.close=function(){this.bridge.postEvent("web_app_close")},i.prototype.isVersionAtLeast=function(t){return e.compareVersions(t,this.version)>=0},i.prototype.openLink=function(e){if(e=r(e),t.supports("web_app_open_link",this.version))return this.bridge.postEvent("web_app_open_link",{url:e});window.open(e,"_blank")},i.prototype.openTelegramLink=function(e){var i=new URL(r(e)),o=i.hostname,n=i.pathname,s=i.search;if("t.me"!==o)throw new Error("URL has not allowed hostname: ".concat(o,'. Only "t.me" is allowed'));if(t.supports("web_app_open_tg_link",this.version))return this.bridge.postEvent("web_app_open_tg_link",{path_full:n+s});window.location.href=e},i.prototype.openInvoice=function(e){var t=this,i=new URL(r(e)),o=i.hostname,n=i.pathname;if("t.me"!==o)throw new Error("Incorrect hostname: "+o);var s=n.match(/^\/(\$|invoice\/)([A-Za-z0-9\-_=]+)$/);if(null===s)throw new Error('Link pathname has incorrect format. Expected to receive "/invoice/slug" or "/$slug"');return this.bridge.postEvent("web_app_open_invoice",{slug:s[2]}),new Promise((function(e){var i=function(o){t.bridge.off("invoice_closed",i),e(o.status)};t.bridge.on("invoice_closed",i)}))},Object.defineProperty(i.prototype,"platform",{get:function(){return this._platform},enumerable:!1,configurable:!0}),i.prototype.ready=function(){this.bridge.postEvent("web_app_ready")},i.prototype.readTextFromClipboard=function(){for(var e=this,t="",i=0;i<32;i++)t+=Math.ceil(10*Math.random()).toString();return new Promise((function(i){var o=function(r){r.req_id===t&&(i(void 0===r.data?null:r.data),e.bridge.off("clipboard_text_received",o))};e.bridge.on("clipboard_text_received",o),e.bridge.postEvent("web_app_read_text_from_clipboard",{req_id:t})}))},i.prototype.sendData=function(e){var t=new Blob([e]).size;if(0===t||t>4096)throw new Error("Passed data has incorrect size: ".concat(t));this.bridge.postEvent("web_app_data_send",{data:e})},i}(),x=e.createSearchParamsStructParser({version:["tgWebAppVersion",e.parseSearchParamAsString],initData:["tgWebAppData",o.extractInitDataFromSearchParams],platform:["tgWebAppPlatform",e.parseSearchParamAsString],themeParams:["tgWebAppThemeParams",i.extractThemeFromJson]});var C=function(e){function t(i,o){var r=e.call(this,'Method "'.concat(i,'" is not supported in Web Apps version ').concat(o,"."))||this;return Object.setPrototypeOf(r,t.prototype),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}l(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}(t,e),t}(Error),P=function(e,i){var o=this;this.bridge=e,this.version=i,this.postEvent=function(e,i){if(!t.supports(e,o.version))throw new C(e,o.version);return o.bridge.postEvent(e,i)},this.on=this.bridge.on.bind(this.bridge),this.off=this.bridge.off.bind(this.bridge)};exports.BackButton=s,exports.ClosingConfirmation=a,exports.HapticFeedback=c,exports.InitData=p,exports.Layout=h,exports.MainButton=u,exports.MethodUnsupportedError=C,exports.Popup=_,exports.QRScanner=g,exports.ThemeParams=m,exports.Viewport=v,exports.WebApp=w,exports.init=function(e){return void 0===e&&(e={}),b(this,void 0,void 0,(function(){var i,o,r,n,l,f,b,y,C,E,O,k,j,V,S,A,q,T,B,D,I,H,L,z,W;return d(this,(function(d){switch(d.label){case 0:return i=e.checkCompat,o=void 0===i||i,r=function(){var e="__initParams";try{var t=window.location.hash.slice(1),i=x(t);return sessionStorage.setItem(e,t),i}catch(e){}try{return x(sessionStorage.getItem(e)||"")}catch(e){}throw new Error("Unable to extract Web App data.")}(),n=r.initData,l=n.authDate,f=n.hash,b=function(e,t){var i={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(i[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(i[o[r]]=e[o[r]])}return i}(n,["authDate","hash"]),y=r.version,C=r.platform,E=r.themeParams,O=E.backgroundColor,k=void 0===O?"#ffffff":O,j=E.buttonColor,V=void 0===j?"#000000":j,S=E.buttonTextColor,A=void 0===S?"#ffffff":S,q=t.init(e),T=o?new P(q,y):q,t.isBrowserEnv()&&((B=document.createElement("style")).id="__tg-iframe-style__",document.head.appendChild(B),q.on("set_custom_style",(function(e){return B.innerHTML=e})),q.postEvent("iframe_ready")),"tdesktop"===C||"macos"===C?[3,2]:[4,v.request(T)];case 1:return W=d.sent(),[3,3];case 2:W={width:window.innerWidth,height:window.innerHeight,isStateStable:!0,isExpanded:!0},d.label=3;case 3:return I=(D=W).width,H=D.isExpanded,L=D.height,z=D.isStateStable,[2,{backButton:new s(T,y),bridge:q,closingConfirmation:new a(T),haptic:new c(T,y),initData:new p(l,f,b),layout:new h(T,y,"bg_color",k),mainButton:new u(T,V,A),popup:new _(T,y),qrScanner:new g(T,y),themeParams:m.synced(T,E),viewport:v.synced(T,L,I,z?L:0,H),webApp:new w(T,y,C)}]}}))}))};
