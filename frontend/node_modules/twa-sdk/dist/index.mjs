import{EventEmitter as e,isColorDark as t,compareVersions as i,createSearchParamsStructParser as o,parseSearchParamAsString as n}from"twa-core";import{supports as r,init as s,isBrowserEnv as a}from"twa-bridge";import{extractThemeFromJson as c}from"twa-theme-params";import{extractInitDataFromSearchParams as h}from"twa-init-data";function u(e){var t=document.createElement("a");if(t.href=e,"http:"!==t.protocol&&"https:"!==t.protocol)throw Error("URL protocol is not supported by OS, or link has not allowed "+"protocol: ".concat(t.protocol));return t.href}function p(e,t){return function(i){return r(t[i],e)}}var l=function(){function t(t,i){var o=this;this.bridge=t,this.ee=new e,this._isVisible=!1,this.on=function(e,t){if("click"===e)return o.bridge.on("back_button_pressed",t);o.ee.on(e,t)},this.off=function(e,t){if("click"===e)return o.bridge.off("back_button_pressed",t);o.ee.off(e,t)},this.supports=p(i,{show:"web_app_setup_back_button",hide:"web_app_setup_back_button"})}return Object.defineProperty(t.prototype,"isVisible",{get:function(){return this._isVisible},set:function(e){this.bridge.postEvent("web_app_setup_back_button",{is_visible:e}),this._isVisible!==e&&(this._isVisible=e,this.ee.emit("visibleChanged",e))},enumerable:!1,configurable:!0}),t.prototype.hide=function(){this.isVisible=!1},t.prototype.show=function(){this.isVisible=!0},t}(),f=function(){function t(t){this.bridge=t,this.ee=new e,this._isEnabled=!1,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee)}return Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this.bridge.postEvent("web_app_setup_closing_behavior",{need_confirmation:e}),this._isEnabled!==e&&(this._isEnabled=e,this.ee.emit("change",e))},enumerable:!1,configurable:!0}),t.prototype.disable=function(){this.isEnabled=!1},t.prototype.enable=function(){this.isEnabled=!0},t}(),b=function(){function e(e,t){this.bridge=e,this.supports=p(t,{impactOccurred:"web_app_trigger_haptic_feedback",notificationOccurred:"web_app_trigger_haptic_feedback",selectionChanged:"web_app_trigger_haptic_feedback"})}return e.prototype.impactOccurred=function(e){this.bridge.postEvent("web_app_trigger_haptic_feedback",{type:"impact",impact_style:e})},e.prototype.notificationOccurred=function(e){this.bridge.postEvent("web_app_trigger_haptic_feedback",{type:"notification",notification_type:e})},e.prototype.selectionChanged=function(){this.bridge.postEvent("web_app_trigger_haptic_feedback",{type:"selection_change"})},e}(),d=function(){function e(e,t,i){void 0===i&&(i={}),this._authDate=e,this._hash=t,this._canSendAfter=null,this._chat=null,this._queryId=null,this._receiver=null,this._startParam=null,this._user=null;var o=i.chat,n=void 0===o?null:o,r=i.user,s=void 0===r?null:r,a=i.queryId,c=void 0===a?null:a,h=i.receiver,u=void 0===h?null:h,p=i.startParam,l=void 0===p?null:p,f=i.canSendAfter,b=void 0===f?null:f;this._canSendAfter=b,this._chat=n,this._user=s,this._queryId=c,this._receiver=u,this._startParam=l}return Object.defineProperty(e.prototype,"authDate",{get:function(){return this._authDate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canSendAfter",{get:function(){return this._canSendAfter},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"chat",{get:function(){return this._chat},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hash",{get:function(){return this._hash},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"queryId",{get:function(){return this._queryId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"receiver",{get:function(){return this._receiver},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"startParam",{get:function(){return this._startParam},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"user",{get:function(){return this._user},enumerable:!1,configurable:!0}),e}(),_=function(){function i(t,i,o,n){this.bridge=t,this._headerColor=o,this._backgroundColor=n,this.ee=new e,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this.supports=p(i,{setHeaderColor:"web_app_set_header_color",setBackgroundColor:"web_app_set_background_color"})}return Object.defineProperty(i.prototype,"backgroundColor",{get:function(){return this._backgroundColor},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"colorScheme",{get:function(){return t(this.backgroundColor)?"dark":"light"},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"headerColor",{get:function(){return this._headerColor},enumerable:!1,configurable:!0}),i.prototype.setBackgroundColor=function(e){this.bridge.postEvent("web_app_set_background_color",{color:e}),this._backgroundColor!==e&&(this._backgroundColor=e,this.ee.emit("backgroundColorChanged",e))},i.prototype.setHeaderColor=function(e){this.bridge.postEvent("web_app_set_header_color",{color_key:e}),this._headerColor!==e&&(this._headerColor=e,this.ee.emit("headerColorChanged",e))},i}(),g=function(){function t(t,i,o,n){void 0===n&&(n={});var r=this;this.bridge=t,this._color=i,this._textColor=o,this.ee=new e,this._isActive=!1,this._isVisible=!1,this._isProgressVisible=!1,this._text="",this.on=function(e,t){if("click"===e)return r.bridge.on("main_button_pressed",t);r.ee.on(e,t)},this.off=function(e,t){if("click"===e)return r.bridge.off("main_button_pressed",t);r.ee.off(e,t)};var s=n.autocommit,a=void 0===s||s;this.autocommit=a}return Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(e){var t=this._color;this._color=e,this.autocommit&&this.commit(),this._color!==t&&this.ee.emit("colorChanged",this._color)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isActive",{get:function(){return this._isActive},set:function(e){var t=this._isActive;this._isActive=e,this.autocommit&&this.commit(),this._isActive!==t&&this.ee.emit("activeChanged",this._isActive)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isProgressVisible",{get:function(){return this._isProgressVisible},set:function(e){var t=this._isProgressVisible;this._isProgressVisible=e,this.autocommit&&this.commit(),this._isProgressVisible!==t&&this.ee.emit("progressVisibleChanged",this._isProgressVisible)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isVisible",{get:function(){return this._isVisible},set:function(e){var t=this._isVisible;this._isVisible=e,this.autocommit&&this.commit(),this._isVisible!==t&&this.ee.emit("visibleChanged",this._isVisible)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"text",{get:function(){return this._text},set:function(e){var t=this._text;this._text=e,this.autocommit&&this.commit(),this._text!==t&&this.ee.emit("textChanged",e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textColor",{get:function(){return this._textColor},set:function(e){var t=this._textColor;this._textColor=e,this.autocommit&&this.commit(),this._textColor!==t&&this.ee.emit("textColorChanged",this._textColor)},enumerable:!1,configurable:!0}),t.prototype.commit=function(){""!==this.text&&this.bridge.postEvent("web_app_setup_main_button",{is_visible:this.isVisible,is_active:this.isActive,is_progress_visible:this.isProgressVisible,text:this.text,color:this.color,text_color:this.textColor})},t.prototype.disable=function(){return this.isActive=!1,this},t.prototype.enable=function(){return this.isActive=!0,this},t.prototype.hide=function(){return this.isVisible=!1,this},t.prototype.hideProgress=function(){return this.isProgressVisible=!1,this},t.prototype.show=function(){return this.isVisible=!0,this},t.prototype.showProgress=function(){return this.isProgressVisible=!0,this},t.prototype.setText=function(e){return this.text=e,this},t.prototype.setTextColor=function(e){return this.textColor=e,this},t.prototype.setColor=function(e){return this.color=e,this},t}(),m=function(e,t){return m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},m(e,t)};var y=function(){return y=Object.assign||function(e){for(var t,i=1,o=arguments.length;i<o;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},y.apply(this,arguments)};function v(e,t,i,o){return new(i||(i=Promise))((function(n,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))}function w(e,t){var i,o,n,r,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(a){return function(c){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;r&&(r=0,a[0]&&(s=0)),s;)try{if(i=1,o&&(n=2&a[0]?o.return:a[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,a[1])).done)return n;switch(o=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(n=s.trys,(n=n.length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){s.label=a[1];break}if(6===a[0]&&s.label<n[1]){s.label=n[1],n=a;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(a);break}n[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],o=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}var C=function(){function t(t,i){this.bridge=t,this.ee=new e,this._isOpened=!1,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this.supports=p(i,{open:"web_app_open_popup"})}return Object.defineProperty(t.prototype,"isOpened",{get:function(){return this._isOpened},set:function(e){this._isOpened!==e&&(this._isOpened=e,this.ee.emit("openChanged",this._isOpened))},enumerable:!1,configurable:!0}),t.prototype.open=function(e){var t=this;if(this.isOpened)throw new Error("Popup is already opened.");var i=function(e){var t=e.message.trim(),i=(e.title||"").trim(),o=e.buttons||[];if(i.length>64)throw new Error("Title has incorrect size: ".concat(i.length));if(0===t.length||t.length>256)throw new Error("Message has incorrect size: ".concat(t.length));if(o.length>3)throw new Error("Buttons have incorrect size: ".concat(o.length));return{title:i,message:t,buttons:0===o.length?[{type:"close",id:""}]:o.map((function(e){var t=e.id,i=void 0===t?"":t;if(i.length>64)throw new Error("Button ID has incorrect size: ".concat(i));switch(e.type){case void 0:case"default":case"destructive":if(e.text=e.text.trim(),0===e.text.length||e.text.length>64){var o=e.type||"default";throw new Error('Button text with type "'.concat(o,'" has incorrect size: ').concat(e.text.length))}}return y(y({},e),{id:i})}))}}(e);return this.bridge.postEvent("web_app_open_popup",i),this.isOpened=!0,new Promise((function(e){var i=function(o){var n=o.button_id,r=void 0===n?null:n;t.bridge.off("popup_closed",i),e(r),t.isOpened=!1};t.bridge.on("popup_closed",i)}))},t}(),O=function(){function t(t,i){this.bridge=t,this._isOpened=!1,this.ee=new e,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this.supports=p(i,{close:"web_app_close_scan_qr_popup",open:"web_app_open_scan_qr_popup"})}return t.prototype.close=function(){this.bridge.postEvent("web_app_close_scan_qr_popup"),this.isOpened=!1},Object.defineProperty(t.prototype,"isOpened",{get:function(){return this._isOpened},set:function(e){this._isOpened!==e&&(this._isOpened=e,this.ee.emit("openChanged",e))},enumerable:!1,configurable:!0}),t.prototype.open=function(e){var t=this;if(this.isOpened)throw new Error("QR scanner is already opened.");return this.bridge.postEvent("web_app_open_scan_qr_popup",{text:e}),this.isOpened=!0,new Promise((function(e){var i=function(){e(null),n()},o=function(t){var i=t.data;e(void 0===i?null:i),n()},n=function(){t.bridge.off("scan_qr_popup_closed",i),t.bridge.off("qr_text_received",o)};t.bridge.on("qr_text_received",o),t.bridge.on("scan_qr_popup_closed",i)}))},t}(),P=function(){function i(t){this.ee=new e,this._backgroundColor=null,this._buttonColor=null,this._buttonTextColor=null,this._hintColor=null,this._linkColor=null,this._secondaryBackgroundColor=null,this._textColor=null,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this.assignThemeParams(t,!1)}return i.request=function(e){return e.postEvent("web_app_request_theme"),new Promise((function(t){var i=function(o){e.off("theme_changed",i),t(c(o))};e.on("theme_changed",i)}))},i.synced=function(e,t){var o=new i(t);return e.on("theme_changed",(function(e){o.assignThemeParams(c(e),!0)})),o},i.prototype.assignThemeParams=function(e,t){var i=this,o=!1;["buttonColor","buttonTextColor","linkColor","textColor","hintColor","secondaryBackgroundColor","backgroundColor"].forEach((function(t){var n=e[t];if(void 0!==n){var r="_"+t;i[r]!==n&&(i[r]=n,o=!0)}})),o&&t&&this.ee.emit("change")},Object.defineProperty(i.prototype,"backgroundColor",{get:function(){return this._backgroundColor},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"buttonColor",{get:function(){return this._buttonColor},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"buttonTextColor",{get:function(){return this._buttonTextColor},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"hintColor",{get:function(){return this._hintColor},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isDark",{get:function(){var e=this.backgroundColor;return null===e||t(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"linkColor",{get:function(){return this._linkColor},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"secondaryBackgroundColor",{get:function(){return this._secondaryBackgroundColor},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"textColor",{get:function(){return this._textColor},enumerable:!1,configurable:!0}),i}();function x(e){return e<0?0:e}var E=function(){function t(t,i,o,n,r){this.bridge=t,this.ee=new e,this.on=this.ee.on.bind(this.ee),this.off=this.ee.off.bind(this.ee),this._height=x(i),this._width=x(o),this._stableHeight=x(n),this._isExpanded=r}return t.request=function(e){return e.postEvent("web_app_request_viewport"),new Promise((function(t){var i=function(o){e.off("viewport_changed",i);var n=o.height,r=o.width,s=o.is_expanded,a=o.is_state_stable;t({height:n,isExpanded:s,width:r,isStateStable:a})};e.on("viewport_changed",i)}))},t.synced=function(e,i,o,n,r){var s=new t(e,i,o,n,r);return e.on("viewport_changed",(function(e){var t=e.height,i=e.width,o=e.is_expanded,n=e.is_state_stable;s.height=x(t),s.width=x(i),s.isExpanded=o,n&&(s.stableHeight=s.height)})),s},Object.defineProperty(t.prototype,"height",{get:function(){return this._height},set:function(e){this._height!==e&&(this._height=e,this.ee.emit("heightChanged",e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stableHeight",{get:function(){return this._stableHeight},set:function(e){this._stableHeight!==e&&(this._stableHeight=e,this.ee.emit("stableHeightChanged",e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isExpanded",{get:function(){return this._isExpanded},set:function(e){this._isExpanded!==e&&(this._isExpanded=e,this.ee.emit("expansionChanged",e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this.ee.emit("widthChanged",e))},enumerable:!1,configurable:!0}),t.prototype.expand=function(){this.bridge.postEvent("web_app_expand")},Object.defineProperty(t.prototype,"isStable",{get:function(){return this._stableHeight===this._height},enumerable:!1,configurable:!0}),t}(),k=function(){function e(e,t,i){this.bridge=e,this._platform=i,this.supports=p(t,{openInvoice:"web_app_open_invoice",readTextFromClipboard:"web_app_read_text_from_clipboard"}),this.version=t}return e.prototype.close=function(){this.bridge.postEvent("web_app_close")},e.prototype.isVersionAtLeast=function(e){return i(e,this.version)>=0},e.prototype.openLink=function(e){if(e=u(e),r("web_app_open_link",this.version))return this.bridge.postEvent("web_app_open_link",{url:e});window.open(e,"_blank")},e.prototype.openTelegramLink=function(e){var t=new URL(u(e)),i=t.hostname,o=t.pathname,n=t.search;if("t.me"!==i)throw new Error("URL has not allowed hostname: ".concat(i,'. Only "t.me" is allowed'));if(r("web_app_open_tg_link",this.version))return this.bridge.postEvent("web_app_open_tg_link",{path_full:o+n});window.location.href=e},e.prototype.openInvoice=function(e){var t=this,i=new URL(u(e)),o=i.hostname,n=i.pathname;if("t.me"!==o)throw new Error("Incorrect hostname: "+o);var r=n.match(/^\/(\$|invoice\/)([A-Za-z0-9\-_=]+)$/);if(null===r)throw new Error('Link pathname has incorrect format. Expected to receive "/invoice/slug" or "/$slug"');return this.bridge.postEvent("web_app_open_invoice",{slug:r[2]}),new Promise((function(e){var i=function(o){t.bridge.off("invoice_closed",i),e(o.status)};t.bridge.on("invoice_closed",i)}))},Object.defineProperty(e.prototype,"platform",{get:function(){return this._platform},enumerable:!1,configurable:!0}),e.prototype.ready=function(){this.bridge.postEvent("web_app_ready")},e.prototype.readTextFromClipboard=function(){for(var e=this,t="",i=0;i<32;i++)t+=Math.ceil(10*Math.random()).toString();return new Promise((function(i){var o=function(n){n.req_id===t&&(i(void 0===n.data?null:n.data),e.bridge.off("clipboard_text_received",o))};e.bridge.on("clipboard_text_received",o),e.bridge.postEvent("web_app_read_text_from_clipboard",{req_id:t})}))},e.prototype.sendData=function(e){var t=new Blob([e]).size;if(0===t||t>4096)throw new Error("Passed data has incorrect size: ".concat(t));this.bridge.postEvent("web_app_data_send",{data:e})},e}(),j=o({version:["tgWebAppVersion",n],initData:["tgWebAppData",h],platform:["tgWebAppPlatform",n],themeParams:["tgWebAppThemeParams",c]});var V=function(e){function t(i,o){var n=e.call(this,'Method "'.concat(i,'" is not supported in Web Apps version ').concat(o,"."))||this;return Object.setPrototypeOf(n,t.prototype),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}m(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}(t,e),t}(Error),A=function(e,t){var i=this;this.bridge=e,this.version=t,this.postEvent=function(e,t){if(!r(e,i.version))throw new V(e,i.version);return i.bridge.postEvent(e,t)},this.on=this.bridge.on.bind(this.bridge),this.off=this.bridge.off.bind(this.bridge)};function S(e){return void 0===e&&(e={}),v(this,void 0,void 0,(function(){var t,i,o,n,r,c,h,u,p,m,y,v,x,V,S,q,T,B,D,H,I,L,z,W,M;return w(this,(function(w){switch(w.label){case 0:return t=e.checkCompat,i=void 0===t||t,o=function(){var e="__initParams";try{var t=window.location.hash.slice(1),i=j(t);return sessionStorage.setItem(e,t),i}catch(e){}try{return j(sessionStorage.getItem(e)||"")}catch(e){}throw new Error("Unable to extract Web App data.")}(),n=o.initData,r=n.authDate,c=n.hash,h=function(e,t){var i={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(i[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(i[o[n]]=e[o[n]])}return i}(n,["authDate","hash"]),u=o.version,p=o.platform,m=o.themeParams,y=m.backgroundColor,v=void 0===y?"#ffffff":y,x=m.buttonColor,V=void 0===x?"#000000":x,S=m.buttonTextColor,q=void 0===S?"#ffffff":S,T=s(e),B=i?new A(T,u):T,a()&&((D=document.createElement("style")).id="__tg-iframe-style__",document.head.appendChild(D),T.on("set_custom_style",(function(e){return D.innerHTML=e})),T.postEvent("iframe_ready")),"tdesktop"===p||"macos"===p?[3,2]:[4,E.request(B)];case 1:return M=w.sent(),[3,3];case 2:M={width:window.innerWidth,height:window.innerHeight,isStateStable:!0,isExpanded:!0},w.label=3;case 3:return I=(H=M).width,L=H.isExpanded,z=H.height,W=H.isStateStable,[2,{backButton:new l(B,u),bridge:T,closingConfirmation:new f(B),haptic:new b(B,u),initData:new d(r,c,h),layout:new _(B,u,"bg_color",v),mainButton:new g(B,V,q),popup:new C(B,u),qrScanner:new O(B,u),themeParams:P.synced(B,m),viewport:E.synced(B,z,I,W?z:0,L),webApp:new k(B,u,p)}]}}))}))}export{l as BackButton,f as ClosingConfirmation,b as HapticFeedback,d as InitData,_ as Layout,g as MainButton,V as MethodUnsupportedError,C as Popup,O as QRScanner,P as ThemeParams,E as Viewport,k as WebApp,S as init};
